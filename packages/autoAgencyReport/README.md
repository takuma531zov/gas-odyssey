# 代理店進捗報告自動化システム

## 概要

日次で行っている代理店への進捗報告をGASで自動化するシステムです。
曜日ベースで送信対象を判定し、Gmail/LINE/GoogleChatの3つのプラットフォームに対応しています。

## 機能

### コア機能
- 曜日ベースの自動送信対象判定
- ファイル差分検出（最新送信済みファイルとの比較）
- マルチプラットフォーム送信（Gmail/LINE/GoogleChat）
- テンプレート変数置換（`{{会社名}}`、`{{担当者}}`）
- 包括的なログ記録
- 送信済みファイルの自動アーカイブ（年/月フォルダ）

### 対応プラットフォーム
- **Gmail**: TOアドレス、CCアドレス対応
- **LINE**: LINE Messaging API使用
- **Google Chat**: Webhook URL使用

## システム構成

```
src/
├── index.ts                    # メイン処理（トリガー関数）
├── env.ts                      # 環境変数定義
├── types/
│   └── index.ts               # 型定義
├── config/
│   └── constants.ts           # 定数定義
├── services/
│   ├── agencyService.ts       # 代理店情報取得
│   ├── templateService.ts     # テンプレート処理
│   ├── fileService.ts         # Drive操作・ファイル比較
│   └── messageSender.ts       # メッセージ送信
└── utils/
    ├── dateUtils.ts           # 曜日判定
    ├── logUtils.ts            # ログ出力
    └── templateParser.ts      # テンプレート変数置換
```

## スプレッドシート構成

### 代理店リスト

| 列 | 項目 | 説明 | 必須 |
|---|---|---|---|
| A | 会社名 | 代理店の会社名 | ○ |
| B | 担当者名 | 担当者名（テンプレート変数用） | - |
| C | 使用テンプレ | テンプレートシート名 | ○ |
| D | 送信媒体 | Gmail, LINE, GoogleChat | ○ |
| E | ルームID | LINE: ルームID / GoogleChat: Webhook URL | △ |
| F | TOアドレス | 送信先アドレス（,区切り） | ○ |
| G | CCアドレス | CCアドレス（,区切り） | - |
| H | 送信日 | 送信対象曜日（,区切り 例: "月,水,金"） | ○ |

### テンプレートシート

| セル | 内容 |
|---|---|
| A1 | 件名 |
| A2 | 本文 |

使用可能な変数: `{{会社名}}`、`{{担当者}}`

### 送信ログシート

送信結果、エラー、差分サマリーを自動記録

## Drive構成

```
ルートフォルダ
├── スプレッドシート（コンテナバインド）
└── 各代理店用フォルダ（会社名と一致）
    ├── 添付対象ファイル（スプレッドシート）
    └── 送信済みフォルダ
        └── 年 → 月 → 送信済みファイル
```

## セットアップ手順

### 1. スクリプトプロパティの設定

| キー | 説明 | 例 |
|---|---|---|
| `PARENT_FOLDER_ID` | ルートフォルダのDrive ID | `1AbC...` |
| `SENDER_NAME` | メッセージ送信者名 | `進捗報告システム` |
| `SHEET_AGENCY_LIST_NAME` | 代理店リストシート名 | `代理店リスト` |
| `SHEET_LOG_NAME` | ログシート名 | `送信ログ` |
| `MAIL_BODY_SOURCE_COLUMN` | 差分に含める列名 | `A` |
| `LINE_BOT_TOKEN` | LINE Bot Token（LINE使用時） | `abc123...` |

### 2. トリガーの設定

GASエディタで `setupDailyTrigger()` を実行
- 毎日午前9時に自動実行されます

### 3. スプレッドシート・Driveフォルダの準備

1. 代理店リスト、テンプレートシート、送信ログシートを作成
2. ルートフォルダと各代理店フォルダを作成（会社名と一致）
3. 各代理店フォルダに添付対象のスプレッドシートを配置

## トリガー設定
- 実行する関数：`dailySendReport`
- 実行するデプロイ：Head
- イベントのソース：時間主導型
- イベントの種類：日付ベースのタイマー（毎日午前9時）

## 環境
### 本番環境
- [Spreadsheets]()
- [Google Apps Script]()

### 検証環境
- [Spreadsheets]()
- [Google Apps Script]()

## 検証方法

### 手動実行テスト
1. GASエディタで `dailySendReport()` を実行
2. 送信ログシートで結果を確認

### 曜日フィルタテスト
1. 代理店リストのH列に本日の曜日を設定
2. 手動実行して対象が正しく抽出されるか確認

### 差分検出テスト
1. 添付対象ファイルを更新
2. 手動実行して差分が正しく検出されるか確認

## トラブルシューティング

### 送信されない
- 代理店リストのH列が本日の曜日と一致しているか確認
- 添付対象ファイルが存在するか確認

### LINE送信できない
- `LINE_BOT_TOKEN`がスクリプトプロパティに設定されているか確認
- ルームIDが正しく設定されているか確認

### テンプレート変数が置換されない
- 変数が`{{会社名}}`、`{{担当者}}`の形式か確認（全角中括弧）

## 開発
開発手順については、[こちら](/README.md)を参照
