# microCMS タグ事前登録用タイムトリガー関数追加プロンプト

## 概要

`packages/apsisArticlePublisher` に **新規関数**を追加してください。

この関数は、  
**Google スプレッドシートで管理している投稿予定記事のタグ列を確認し、  
microCMS の tags コンテンツに存在しないタグがあれば事前に登録する**  
ための **タイムトリガー実行用関数**です。

記事投稿処理よりも前に実行されることを想定しています。

---

## 対象スプレッドシート

- シート名  
  - `BLOG_ARTICLE_LIST_SHEET_NAME`（スクリプトプロパティで定義済み）

- タグ列  
  - `TAGS_COLUMN`（スクリプトプロパティで定義済み）

---

## タグ列の仕様

- 1セルに **カンマ区切り（,）**で複数タグを入力
- 各値は **タグ名（表示名）**を表す

### 例

```
GAS, Google Apps Script, microCMS
```

---

## タグ生成ルール

### タグ名（表示名）

- スプレッドシートの `TAGS_COLUMN` の値をそのまま使用

### タグID（slug）

- タグ名を以下のルールで変換して生成する

#### 変換ルール

1. 小文字化  
2. 前後の空白トリム  
3. 半角スペース → ハイフン（`-`）  
4. 連続ハイフンは 1 つにまとめる  

#### 変換例

| TAGS_COLUMN の値 | tag_name（表示名） | tag_id（slug） |
|------------------|-------------------|----------------|
| GAS | GAS | gas |
| Google Apps Script | Google Apps Script | google-apps-script |

---

## microCMS 側の tags コンテンツ構造

以下のような構造を想定しています。

```json
{
  "id": "bgsbxsw7sjoz",
  "tag_id": "gemeni-cli",
  "tag_name": "Gemini CLI",
  "category_id": [
    {
      "category_id": "ai-agent",
      "category_name": "AI Agent"
    }
  ]
}
```

### 今回の実装方針

- `tag_id`（slug）：必須  
- `tag_name`（表示名）：必須  
- `category_id`：**今回は設定しない（未指定でOK）**

---

## 処理要件

### 1. スプレッドシートからタグ一覧を収集

- `BLOG_ARTICLE_LIST_SHEET_NAME` の全行を対象
- `TAGS_COLUMN` が空でない行のみ処理
- カンマ区切りで分割し、全タグを **重複排除**して収集

---

### 2. microCMS に登録済みタグ一覧を取得

- microCMS の tags エンドポイントから全件取得
- 既存コードの **認証情報・エンドポイント定義を再利用**

---

### 3. 未登録タグのみを抽出

- 比較対象：`tag_id`
- スプレッドシート由来の `tag_id` が  
  microCMS 側に存在しないもののみを抽出

---

### 4. 未登録タグを microCMS に事前登録

登録データ形式：

```json
{
  "tag_id": "google-apps-script",
  "tag_name": "Google Apps Script"
}
```

- すでに存在する場合は **登録しない**
- エラーがあっても **他のタグ処理は継続**

---

## 実行形態

- **タイムトリガー実行を前提**
- 記事投稿処理とは独立した関数として実装
- 定期実行（例：1日1回）を想定

---

## 実装上の注意点

- microCMS API 制限を考慮し、不要な POST は行わない
- ログは以下を最低限出力する  
  - 取得したタグ数  
  - 新規登録したタグ一覧  
  - 登録失敗時のエラー内容（タグ単位）

---

## ゴール

- 記事投稿前に **タグ未登録エラーが発生しない状態**を作る  
- スプレッドシートを唯一のタグ入力元として運用できるようにする  
