# URLFinder

WebサイトからContact Form URLを自動検出するGoogle Apps Script (GAS) アプリケーション

## 概要

URLFinderは、指定されたWebサイトのURLから自動的に問い合わせフォームを検出し、結果をスプレッドシートに出力するツールです。大量のWebサイトから効率的にコンタクト情報を収集することができます。

### 主な機能

- **自動フォーム検出**: HTML解析による構造化フォーム検出
- **多様なフォーム対応**: Google Forms、埋め込みフォーム、reCAPTCHA対応
- **バッチ処理**: タイムアウト耐性のある段階的処理
- **柔軟な実行モード**: 全件処理 / チェック行のみ処理
- **設定可能な列構造**: スプレッドシート構造のカスタマイズ対応

## アーキテクチャ

```
URLFinder/
├── src/
│   ├── ContactPageFinder.ts      # メインエントリーポイント
│   ├── env.ts                    # 環境設定管理
│   ├── adapters/gas/             # GAS用アダプター
│   │   ├── triggers.ts          # バッチ処理エンジン
│   │   └── ui.ts                # UI制御
│   ├── functions/               # コア機能
│   │   ├── network/            # ネットワーク処理
│   │   ├── html/               # HTML解析
│   │   └── domain/             # ドメインロジック
│   ├── pipelines/              # 検索パイプライン
│   │   ├── strategies.ts       # 検索戦略
│   │   └── state.ts           # 状態管理
│   └── data/                  # データ定義
│       ├── constants/         # 定数・パターン
│       └── types/            # 型定義
└── dist/                     # ビルド出力
```

## 処理フロー

```
1. スプレッドシートからURL取得
   ↓
2. URL Pattern 検索戦略
   - 高優先度パターン検索 (/contact/, /inquiry/, /form/)
   - 200 OK応答のURL記録
   ↓
3. HTML Content Analysis 戦略
   - ホームページHTML解析
   - ナビゲーション検索
   - Google Forms検出
   ↓
4. フォーム検証・分析
   - 構造化フォーム分析
   - 送信ボタン確認
   - reCAPTCHA検出
   ↓
5. 結果出力（バッチ処理）
   - 設定可能なバッチサイズで段階的出力
   - タイムアウト時の進捗保護
```

## セットアップ

### 1. GASへのデプロイ

```bash
# ビルド
npm run build

# dist/main.js の内容をGASエディターにコピー
# simple-options.html も同様にアップロード
```

### 2. スクリプトプロパティ設定

GAS管理画面 > プロジェクトの設定 > スクリプト プロパティで以下を設定：

| プロパティ名 | 説明 | デフォルト値 | 必須 |
|-------------|------|-------------|------|
| SHEET | 対象シート名 | - | 必須 |
| MAX_COUNT | 最大処理件数 | 制限なし | 任意 |
| HEADER_ROW | ヘッダー行番号 | 1 | 任意 |
| BATCH_SIZE | バッチサイズ | 10 | 任意 |
| TARGET_COLUMN | 対象URL列 | L | 任意 |
| OUTPUT_COLUMN | 結果出力列 | AP | 任意 |
| CHECK_COLUMN | チェックボックス列 | AQ | 任意 |
| MAX_TOTAL_TIME | 最大処理時間(ms) | - | 必須 |

### 3. スプレッドシート準備

- 対象URL列（デフォルト: L列）にWebサイトURLを入力
- チェックボックス列（デフォルト: AQ列）にチェックボックス挿入（選択処理用）
- 結果出力列（デフォルト: AP列）は自動入力されます

## 使用方法

### UI付き実行（推奨）

1. スプレッドシートで executeUrlFinderWithUI 関数を実行
2. 実行オプション選択ダイアログが表示
3. 処理モードを選択：
   - **通常処理**: MAX_COUNT設定に基づいて順次処理
   - **チェック行のみ処理**: AQ列でチェックされた行のみを処理

### 直接実行

```javascript
// 通常のバッチ処理
processContactPageFinder();

// テスト実行
test();
```

## 検出結果の種類

| 結果パターン | 出力内容 |
|-------------|---------|
| 成功: フォームURL発見 | 実際のフォームURL |
| 成功: Google Forms | Google FormsのURL |
| 成功: 埋め込みフォーム | フォームが存在するページURL |
| 部分成功: 候補ページ | 問い合わせページのURL |
| 失敗: フォーム未発見 | "問い合わせフォームが見つかりませんでした" |
| エラー: DNS/接続 | 具体的なエラーメッセージ |
| エラー: アクセス制限 | "Access forbidden" など |

## トラブルシューティング

### タイムアウトエラーが発生する場合

**症状**: 処理中にタイムアウトが発生し、一部の結果が出力されない

**対策**:
1. **バッチサイズを調整**
   ```javascript
   // スクリプトプロパティで調整
   BATCH_SIZE = 5  // デフォルト10から削減
   ```

2. **MAX_COUNTで処理件数を制限**
   ```javascript
   MAX_COUNT = 20  // 一回の実行で20件まで
   ```

3. **段階的実行**
   - 処理は既に出力済みの次の行から自動再開されます
   - 繰り返し実行することで全件処理完了

### スプレッドシート構造を変更したい場合

```javascript
// 列を変更する場合
TARGET_COLUMN = "M"   // URL列をM列に変更
OUTPUT_COLUMN = "AQ"  // 出力列をAQ列に変更
CHECK_COLUMN = "AR"   // チェック列をAR列に変更
```

### よくあるエラーメッセージ

| エラーメッセージ | 原因 | 対策 |
|-----------------|------|------|
| "DNS解決失敗" | URLが無効またはサイトが存在しない | URL形式を確認 |
| "Access forbidden" | ボット対策でアクセス制限 | 手動確認が必要 |
| "シート「xxx」が見つかりません" | SHEET設定が間違っている | スクリプトプロパティを確認 |

## 技術仕様

- **対応フォーム**: HTML form, Google Forms, 埋め込みフォーム, reCAPTCHA
- **検出方式**: URL パターンマッチング + HTML解析
- **タイムアウト対応**: バッチ処理による段階的出力
- **処理速度**: バッチ出力により1行ずつ出力の20-40倍高速

