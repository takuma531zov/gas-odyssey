# URLFinder

企業サイトから問い合わせフォームを自動検出するGoogle Apps Script（GAS）ツールです。BtoB営業向けに最適化されており、実際に使用可能な問い合わせフォームのURLを効率的に発見します。

## 概要

URLFinderは与えられた企業サイトのURLから、問い合わせフォームを以下の優先順位で検索します：

1. **URL推測検索**（最優先・高速・高精度）
2. **ホームページHTML解析**（フォールバック）

## 処理フロー

### 1. 初期チェック
- **SNSページ検出**: Facebook、Twitter等のSNSページは処理対象外（GAS制約）
- **ドメイン生存確認**: サイトが稼働しているかチェック
- **候補リストリセット**: 新しい検索のため候補ページリストを初期化

### 2. メイン検索（URL推測検索）
優先度の高いURLパターンを順次テストします：

#### 検索パターン
- `/contact/`, `/contact`
- `/inquiry/`, `/inquiry`
- `/form/`, `/form`
- `/contact-us/`, `/contact-us`
- 日本語URL（エンコード版）:
  - `/%E3%81%8A%E5%95%8F%E3%81%84%E5%90%88%E3%82%8F%E3%81%9B/`（お問い合わせ）
  - `/%E5%95%8F%E3%81%84%E5%90%88%E3%82%8F%E3%81%9B/`（問い合わせ）

#### 各URLのテスト手順
1. **HTTPアクセス**: 該当URLにアクセス
2. **レスポンス確認**: 200 OKかチェック
3. **ページ有効性確認**: 404ページや工事中ページを除外
4. **問い合わせフォーム判定**: 2段階検証
   - **段階1**: `<form>`要素の存在確認
   - **段階2**: 問い合わせ特化送信要素の確認

### 3. フォーム検証

#### 構造化フォーム解析
- `<form>`タグ内の入力要素を解析
- フィールド数、問い合わせ専用フィールドの検出
- 入力要素の種類判定（hidden, button, submit以外をカウント）

#### 問い合わせ特化送信要素の検出
以下のような問い合わせ専用の送信要素を検索：
- 日本語: 'お問い合わせ送信', '問い合わせする', 'ご相談する'
- 英語: 'contact us', 'send message', 'send inquiry'
- HTML属性: `name=".*contact.*submit"`, `value=".*お問い合わせ"`

### 4. 二段階リンク検出（メイン、フォールバック共通処理）
問い合わせページが見つかった場合、そのページ内でさらに詳細なフォームページへのリンクを探索：

#### 実行タイミング
- **メイン検索**: URL推測で問い合わせページが見つかった場合
- **フォールバック処理**: HTML解析で問い合わせリンクが見つかった場合

#### 検索対象キーワード
- URL内パターン: 'form', 'フォーム', 'formzu', 'fc2'
- テキストパターン: 'フォームはこちら', 'フォームへ', '問い合わせフォーム'

#### 候補リンク検証
1. スコア計算による優先順位付け
2. 上位3件のリンクを実際にアクセスして検証
3. Googleフォームや埋め込みフォームの存在確認

### 5. フォールバック処理（ホームページHTML解析）
メイン検索で見つからない場合の特殊ケース対応：

#### 検索順序
1. **Googleフォーム検索**: ホームページ内のGoogleフォームURL検出
2. **HTMLコンテンツ解析**:
   - ナビゲーションメニューから問い合わせリンク検索
   - フッターから問い合わせリンク検索
   - 全体のリンクから問い合わせリンク検索
3. **埋め込みフォーム検出**: ページ内の直接埋め込みフォーム

### 6. 結果の決定

#### 出力フィールド
- **`contactUrl`**: 問い合わせページのURL
- **`actualFormUrl`**: 実際に使用可能なフォームのURL
- **`foundKeywords`**: 検出時に使用されたキーワード
- **`searchMethod`**: 使用された検索手法

#### `actualFormUrl`の値
- GoogleフォームURL: `https://docs.google.com/forms/...`
- 埋め込みフォームページURL: 実際のページURL
- 埋め込みフォーム識別子: `'embedded_contact_form_on_page'`
- 未発見: `null`

### 7. エラーハンドリング

#### 検出されるエラー
- **DNS解決失敗**: ドメインが存在しない
- **Bot対策ブロック**: 403, 501エラーで検出
- **タイムアウト**: 設定時間内にレスポンスなし
- **サイト閉鎖**: サーバー接続不可

## 設定

### スクリプトプロパティ
- `MAX_TOTAL_TIME`: 最大処理時間（ミリ秒、デフォルト: 30000）
- `SHEET`: 処理対象シート名
- `MAX_COUNT`: 一回の処理上限行数
- `HEADER_ROW`: ヘッダー行番号（デフォルト: 1）

### 処理対象データ
- **入力列**: L列（企業サイトURL）
- **出力列**: AP列（検出された問い合わせフォームURL）

## 特徴

### BtoB営業特化
- 資料請求、採用、メルマガ登録フォームを除外
- 一般的な企業問い合わせフォームに特化
- 営業活動で実際に使用可能なフォームを優先検出

### 高速・高精度
- URL推測による高速検索（平均2-3秒/サイト）
- 構造化フォーム解析による高精度判定
- 候補ページシステムによるフォールバック

### 堅牢性
- 詳細なエラー分類とハンドリング
- Bot対策サイト検出と適切な処理中断
- タイムアウト制御によるスクリプト安定性

## 使用方法

### 基本的な使用
```javascript
const result = findContactPage('https://example.com');
console.log(result);
// {
//   contactUrl: 'https://example.com/contact/',
//   actualFormUrl: 'https://docs.google.com/forms/...',
//   foundKeywords: ['contact', 'google_form'],
//   searchMethod: 'contact_form_priority_search'
// }
```

### 一括処理
```javascript
processContactPageFinder(); // スプレッドシート一括処理
```

### テスト実行
```javascript
main(); // テストURL での動作確認
```
