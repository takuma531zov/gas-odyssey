# 営業リスト問い合わせフォーム抽出システム

## プロジェクト概要
スプレッドシートに登録された企業のホームページURLから問い合わせフォームを自動抽出し、フォーム構造データを取得するGoogle Apps Script（GAS）システム。

## 開発環境
- **開発方法**: clasp + TypeScript（ローカル開発）
- **パッケージマネージャー**: pnpm
- **デプロイ先**: Google Apps Script
- **スプレッドシート連携**: Google Sheets API

## システム構成

### データフロー
```
Google スプレッドシート → GAS処理 → 結果を1行ずつスプレッドシートに保存
```

### スプレッドシート構造
- **L列**: 企業ホームページURL（入力済み）
- **AP列**: 問い合わせフォームURL（出力先）
- **AS列**: フォーム構造データ（JSON形式で出力）
- **AT列**: ステータス（エラー時の状況出力）

## 処理フロー詳細

### Step1: 対象リスト抽出
**目的**: 処理対象行の特定
**処理内容**:
- AP列の最終データ行を取得
- AP列最終行+1からL列最終行までを処理対象とする
- 途中の空白行は無視して処理を継続

### Step2: キーワード付きURL順次アクセス
**目的**: 問い合わせページの直接アクセス試行
**技術**: `UrlFetchApp.fetch()`
**アクセスパターン**: `{ホームURL}/{キーワード}`

**キーワード群**:
```javascript
// 英語キーワード
'contact', 'contactus', 'contacts', 'inquiry', 'form', 'mailform', 'otoiawase'

// 日本語キーワード（URLエンコード）
'%E3%81%8A%E5%95%8F%E3%81%84%E5%90%88%E3%82%8F%E3%81%9B',  // お問い合わせ
'%E5%95%8F%E3%81%84%E5%90%88%E3%82%8F%E3%81%9B'           // 問い合わせ

// ローマ字表記
'otoiawase', 'toiawase'
```

**処理内容**:
- ホームURLの末尾`/`の有無を統一処理
- 各キーワードでHTTP GETリクエスト実行
- **レスポンスが200の場合**: 即座にループを抜けてStep3へ
- **200以外の場合**: 次のキーワードで継続
- **全キーワードで200が取れない場合**: Step4へ

### Step3: フォーム要素抽出 + スプレッドシート出力
**目的**: 取得したHTMLから`<form>`要素を抽出し結果を保存
**処理内容**:
- HTMLから`<form>`要素を抽出
- フォーム構造データをJSON化
- **1行ずつ**スプレッドシートに出力
- 次の行の処理へ移行

### Step4: トップページHTML取得・解析
**目的**: キーワードアクセスで見つからない場合のフォールバック
**処理内容**:
- ホームURL（トップページ）のHTML取得
- `<form>`要素の抽出を試行
- **フォームが見つかった場合**: Step3と同様の出力処理
- **フォームが見つからない場合**: Step5へ

### Step5: Googleフォーム検出・抽出
**目的**: サイト内にGoogleフォームが埋め込まれている場合の対応
**検出パターン**:
- `forms.google.com`
- `docs.google.com/forms`

**処理内容**:
- トップページHTMLからGoogleドメインリンクを抽出
- **ヒットした場合**: 該当URLにアクセスして`<form>`要素抽出
- **ヒットしない場合**: Step6へ

### Step6: エラーステータス出力
**目的**: フォームが見つからない場合のステータス記録
**処理内容**:
- AT列にエラーステータスを出力
- AP列セルの背景色を変更（エラー表示）

## フォーム構造データ形式
```json
{
  "formAction": "送信先URL",
  "method": "POST/GET",
  "fields": [
    {
      "name": "フィールド名",
      "type": "input種別",
      "id": "要素ID",
      "required": "必須項目判定",
      "label": "ラベルテキスト"
    }
  ],
  "submitButton": "送信ボタン情報"
}
```

## 技術仕様

### エラーハンドリング
- **基本方針**: HTTP 200以外はエラーとして処理
- **ログ出力**: `console.log()`でデバッグ情報を出力
- **最終エラー**: AT列にステータス出力 + AP列背景色変更

### スプレッドシート更新
- **更新タイミング**: 1行ずつ即座に更新
- **出力列**:
  - AP列: 問い合わせフォームURL
  - AS列: フォーム構造データ（JSON文字列）
  - AT列: エラーステータス（該当時のみ）

### パフォーマンス考慮
- **レスポンス200取得**: 即座にループ終了で効率化
- **タイムアウト**: 各HTTP リクエストに適切なタイムアウト設定
- **順次処理**: 1行完了後に次の行を処理


## ファイル構成
```
src/
├── main.ts              # メイン処理
├── types.ts             # 型定義
├── services/
│   ├── spreadsheet.ts   # スプレッドシート操作
│   ├── scraper.ts       # HTML取得・解析
│   └── form-parser.ts   # フォーム構造解析
├── utils/
│   ├── url.ts           # URL操作ユーティリティ
│   ├── logger.ts        # ログ出力
│   └── constants.ts     # 定数定義（キーワード群等）
└── tests/               # テストファイル
```



## 注意事項
- **レスポンス判定**: HTTP 200のみを成功とし、それ以外はエラー扱い
- **即座終了**: 200レスポンス取得次第、キーワードループを終了
- **1行処理**: スプレッドシート更新は必ず1行ずつ実行
- **メモリ制限**: GASの実行時間・メモリ制限を考慮した実装
- **デバッグ**: 可読性を重視し、適切なログ出力でデバッグを容易に
